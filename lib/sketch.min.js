var __slice=[].slice;(function(e){var t,n,r,i;return e.fn.sketch=function(){var n,r,i;r=arguments[0],n=2<=arguments.length?__slice.call(arguments,1):[],this.length>1&&e.error("Sketch.js can only be called on one element at a time."),i=this.data("sketch");if(typeof r!="string"||!i)return i?i:(this.data("sketch",new t(this.get(0),r)),this);if(!i[r])return e.error("Sketch.js did not recognize the given command.");if(typeof i[r]=="function")return i[r].apply(i,n);if(n.length===0)return i[r];if(n.length===1)return i[r]=n[0]},t=function(){function t(t,n){this.el=t,this.canvas=e(t),this.context=t.getContext("2d"),this.options=e.extend({toolLinks:!0,defaultTool:"marker",defaultColor:"#000000",defaultSize:5},n),this.painting=!1,this.color=this.options.defaultColor,this.size=this.options.defaultSize,this.tool=this.options.defaultTool,this.actions=[],this.action=[],this.undone=[],this.canvas.bind("click mousedown mouseup mousemove mouseleave touchstart touchmove touchend touchcancel mouseenter",this.onEvent),this.options.toolLinks&&e("body").delegate('a[href="#'+this.canvas.attr("id")+'"]',"click",function(t){var n,r,i,s,o,u,a;r=e(this),n=e(r.attr("href")),s=n.data("sketch"),a=["color","size","tool","font","text"];for(o=0,u=a.length;o<u;o++)i=a[o],r.attr("data-"+i)&&s.set(i,e(this).attr("data-"+i));return e(this).attr("data-download")&&s.download(e(this).attr("data-download")),e(this).attr("data-operation")&&s.operation(e(this).attr("data-operation")),!1})}return t.prototype.download=function(e){return window.open(this.save(e))},t.prototype.save=function(e){var t;return e||(e="png"),e==="jpg"&&(e="jpeg"),t="image/"+e,this.el.toDataURL(t)},t.prototype.set=function(e,t){return this[e]=t,this.canvas.trigger("sketch.change"+e,t)},t.prototype.startPainting=function(){if(!this.painting)return this.painting=!0,this.action={tool:this.tool,color:this.color,size:parseFloat(this.size),events:[]}},t.prototype.stopPainting=function(){this.painting=!1;if(this.action)return this.actions.push(this.action),this.action=null,this.redraw()},t.prototype.onEvent=function(t){return t.originalEvent&&t.originalEvent.targetTouches&&(t.pageX=t.originalEvent.targetTouches[0].pageX,t.pageY=t.originalEvent.targetTouches[0].pageY),e.sketch.tools[e(this).data("sketch").tool].onEvent.call(e(this).data("sketch"),t),t.preventDefault(),!1},t.prototype.redraw=function(){var t;this.el.width=this.canvas.width(),this.context=this.el.getContext("2d"),t=this,e.each(this.actions,function(){if(this.tool)return e.sketch.tools[this.tool].draw.call(t,this)});if(this.painting&&this.action)return e.sketch.tools[this.action.tool].draw.call(t,this.action)},t.prototype.setupLine=function(e){return this.context.lineJoin="round",this.context.lineCap="round",this.context.lineWidth=e.size,this.context.strokeStyle=n(e),this.context.fillStyle=n(e)},t.prototype.operation=function(e){switch(e){case"clear":this.actions=[];break;case"undo":this.actions&&this.actions.length>0?this.undone.push(this.actions.pop()):alert("Nothing to undo");break;case"redo":this.undone&&this.undone.length>0?this.actions.push(this.undone.pop()):alert("Nothing to redo")}return this.redraw()},t}(),e.sketch={tools:{}},e.sketch.tools.marker={onEvent:function(e){switch(e.type){case"mousedown":case"touchstart":this.startPainting();break;case"mouseup":case"touchend":case"touchcancel":this.stopPainting()}if(this.painting)return this.action.events.push({x:e.pageX-this.canvas.offset().left,y:e.pageY-this.canvas.offset().top,event:e.type}),this.redraw()},draw:function(e){var t,n,r,i,s,o;this.setupLine(e),this.context.beginPath();if(e.events.length>1){this.context.moveTo(e.events[0].x,e.events[0].y),o=e.events;for(i=0,s=o.length;i<s;i++)t=o[i],this.context.lineTo(t.x,t.y);return this.context.stroke()}if(!this.erasing)return n=e.events[0].x,r=e.events[0].y,this.context.arc(n,r,e.size/2,0,Math.PI*2,!0),this.context.closePath(),this.context.fill()}},e.sketch.tools.eraser={onEvent:function(t){return e.sketch.tools.marker.onEvent.call(this,t)},draw:function(t){var n,r;return this.erasing=!0,n=t.color,r=this.context.globalCompositeOperation,this.context.globalCompositeOperation="copy",t.color="rgba(0,0,0,0)",e.sketch.tools.marker.draw.call(this,t),this.context.globalCompositeOperation=r,this.erasing=!1,t.color=n}},e.sketch.tools.rectangle={onEvent:e.sketch.tools.marker.onEvent,draw:function(e){var t,n,r,i;return this.setupLine(e),r=e.events[0],this.context.moveTo(r.x,r.y),t=e.events[e.events.length-1],i=t.x-r.x,n=t.y-r.y,this.context.strokeRect(r.x,r.y,i,n)}},e.sketch.tools.line={onEvent:e.sketch.tools.marker.onEvent,draw:function(e){var t;return this.setupLine(e),t=e.events[e.events.length-1],this.context.beginPath(),this.context.moveTo(e.events[0].x,e.events[0].y),this.context.lineTo(t.x,t.y),this.context.stroke()}},e.sketch.tools.circle={onEvent:e.sketch.tools.marker.onEvent,draw:function(e){var t,n,r,i,s;return this.setupLine(e),s=e.events[0],this.context.moveTo(e.events[0].x,e.events[0].y),i=e.events[e.events.length-1],t=(i.x+s.x)/2,n=(i.y+s.y)/2,r=Math.sqrt(Math.pow(i.x-s.x,2)+Math.pow(i.y-s.y,2))/2,this.context.beginPath(),this.context.arc(t,n,r,Math.PI*2,0,!0),this.context.stroke(),this.context.closePath()}},e.sketch.tools.text={onEvent:function(e){switch(e.type){case"mouseup":case"touchend":return this.action={tool:this.tool,color:this.color,size:parseFloat(this.size),font:this.font||"normal 20px sans-serif",events:[]},this.action.events.push({x:e.pageX-this.canvas.offset().left,y:e.pageY-this.canvas.offset().top,event:e.type,text:this.text||prompt("Enter text to insert")}),this.actions.push(this.action),this.redraw()}},draw:function(e){var t;t=e.events[0];if(t.text)return this.setupLine(e),this.context.font=e.font,this.context.fillStyle=n(e),this.context.textBaseline="middle",this.context.fillText(t.text,t.x,t.y)}},i=function(){return Math.floor(Math.random()*256)},r=function(){return"rgb("+i()+","+i()+","+i()+")"},n=function(e){return e.color==="random"?r():e.color}})(jQuery);